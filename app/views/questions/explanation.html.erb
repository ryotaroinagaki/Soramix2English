<div class="text-center md:container md:mx-auto mt-6">
  <div class="text-red-500 text-4xl">
    <% if @result.result == true %>
      <h1><%= t('.correct') %></h1>
    <% else %>
      <h1><%= t('.incorrect') %></h1>
    <% end %>
  </div>
  
  <%= render 'explanation', question: @question %>
  
  <div>
    <p><%= t('.answer') %></p>
    <h1 class="text-red-600 font-bold text-2xl"><%= @true_answer.choice %></h1>
    <h1 class="mt-3"><%= t('.japanese') %><%= @question.japanese %></h1>
    
    <h1 class="mt-3 mb-1 text-lg"><%= t('.voice') %><i class="fa-solid fa-microphone"></i></h1>
    <button class="btn btn-info" id="start-btn">start</button>
    <button class="btn btn-error" id="reset-btn">reset</button>
    <div id="result-div" class="text-2xl font-bold"></div>
    
    <script>
      document.querySelector('#start-btn').onclick = () => {
        initializeSpeechRecognition();
        }
        
      //再定義できる変数を宣言
      var startBtn;
      var resetBtn;
      var resultDiv;

      // 関数内で変数を宣言
      function initializeSpeechRecognition() {
        startBtn = document.querySelector('#start-btn');
        resetBtn = document.querySelector('#reset-btn');
        resultDiv = document.querySelector('#result-div');
      
        SpeechRecognition = webkitSpeechRecognition || SpeechRecognition;
        let recognition = new SpeechRecognition();
      
        recognition.lang = 'en-US';
        recognition.interimResults = true;
      
        let finalTranscript = ''; // 確定した(黒の)認識結果
      
        recognition.onresult = (event) => {
          let interimTranscript = ''; // 暫定(灰色)の認識結果
          for (let i = event.resultIndex; i < event.results.length; i++) {
            let transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
              finalTranscript += '<div>' + transcript + '</div>';
            } else {
              interimTranscript = transcript;
            }
          }
          resultDiv.innerHTML = finalTranscript + '<i style="color:#ddd; font-size: 20px;">' + interimTranscript + '</i>';
        }
      
        startBtn.onclick = () => {
          recognition.start();
        }
        resetBtn.onclick = () => {
          finalTranscript = '';
          interimTranscript = '';
          resultDiv.innerHTML = '';
        }
        recognition.start();
      }
    </script>

    <div class="mt-8">
      <%= turbo_frame_tag 'like_button' do %>
        <%= render 'like_button', question: @question %>
      <% end %>
      <%= turbo_frame_tag 'bookmark_button' do %>
        <%= render 'bookmark_button', question: @question %>
      <% end %>
      <%= link_to "https://twitter.com/share?url=#{request.url}&text=#{current_user.name}さんは、「#{@question.music.artist_name}」の「#{@question.music.music_name}」に挑戦しました！ %0A&hashtags=空耳English,空耳,英語", target: '_blank', class: 'btn btn-active btn-neutral text-white bg-black ml-4' do %>
        <i class="fa-brands fa-x-twitter fa-xl"></i>
      <% end %>
    </div>
    <div class="mt-5 mb-6">
      <% if @next_question %>
        <% if session[:total_questions] >= 3 %>
          <%= link_to result_questions_path do %>  
            <button class="btn btn-neutral"><%= t('.result') %></button>
          <% end %>  
        <% else %>
          <%= link_to question_path(@next_question) do %>  
            <button class="btn btn-accent"><%= t('.next_question') %></button>
          <% end %>  
        <% end %>
      <% else %>
        <% if session[:total_questions] >= 3 %>
          <%= link_to result_questions_path do %>  
            <button class="btn btn-neutral"><%= t('.result') %></button>
          <% end %>
        <% else %>
          <%= link_to question_path(@ramdom_question) do %>  
            <button class="btn btn-accent"><%= t('.next_question') %></button>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>


